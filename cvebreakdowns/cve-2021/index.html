<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>CVE-2021-1675 | The Precursor to PrintNightmare | kkso's Writeups</title><meta name=keywords content><meta name=description content="CVE-2021-1675 is a elevation of privilege vulnerability that affected all Windows Servers from version 2004 to 20H2 and all windows desktops from Windows 7 to Windows 10. While CVE-2021-1675 and CVE-2021-34527 (PrintNightmare) take advantage of the windows print spooler, both exploits approach the vulnerability in different ways. CVE-2021-1675 can only be exploited locally and is only used to escalate user privileges while PrintNightmare is uses Remote Code Execution which makes the threat of the vulnerability much higher."><meta name=author content><link rel=canonical href=https://kkso.github.io/cvebreakdowns/cve-2021/><link crossorigin=anonymous href=/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css integrity="sha256-yIlj/i15RiAA/Q+xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.4dcb3c4f38462f66c6b6137227726f5543cb934cca9788f041c087e374491df2.js integrity="sha256-Tcs8TzhGL2bGthNyJ3JvVUPLk0zKl4jwQcCH43RJHfI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://kkso.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://kkso.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://kkso.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://kkso.github.io/apple-touch-icon.png><link rel=mask-icon href=https://kkso.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="CVE-2021-1675 | The Precursor to PrintNightmare"><meta property="og:description" content="CVE-2021-1675 is a elevation of privilege vulnerability that affected all Windows Servers from version 2004 to 20H2 and all windows desktops from Windows 7 to Windows 10. While CVE-2021-1675 and CVE-2021-34527 (PrintNightmare) take advantage of the windows print spooler, both exploits approach the vulnerability in different ways. CVE-2021-1675 can only be exploited locally and is only used to escalate user privileges while PrintNightmare is uses Remote Code Execution which makes the threat of the vulnerability much higher."><meta property="og:type" content="article"><meta property="og:url" content="https://kkso.github.io/cvebreakdowns/cve-2021/"><meta property="article:section" content="CVEBreakdowns"><meta property="article:published_time" content="2022-03-23T05:04:42-07:00"><meta property="article:modified_time" content="2022-03-23T05:04:42-07:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="CVE-2021-1675 | The Precursor to PrintNightmare"><meta name=twitter:description content="CVE-2021-1675 is a elevation of privilege vulnerability that affected all Windows Servers from version 2004 to 20H2 and all windows desktops from Windows 7 to Windows 10. While CVE-2021-1675 and CVE-2021-34527 (PrintNightmare) take advantage of the windows print spooler, both exploits approach the vulnerability in different ways. CVE-2021-1675 can only be exploited locally and is only used to escalate user privileges while PrintNightmare is uses Remote Code Execution which makes the threat of the vulnerability much higher."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"CVEBreakdowns","item":"https://kkso.github.io/cvebreakdowns/"},{"@type":"ListItem","position":2,"name":"CVE-2021-1675 | The Precursor to PrintNightmare","item":"https://kkso.github.io/cvebreakdowns/cve-2021/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"CVE-2021-1675 | The Precursor to PrintNightmare","name":"CVE-2021-1675 | The Precursor to PrintNightmare","description":"CVE-2021-1675 is a elevation of privilege vulnerability that affected all Windows Servers from version 2004 to 20H2 and all windows desktops from Windows 7 to Windows 10. While CVE-2021-1675 and CVE-2021-34527 (PrintNightmare) take advantage of the windows print spooler, both exploits approach the vulnerability in different ways. CVE-2021-1675 can only be exploited locally and is only used to escalate user privileges while PrintNightmare is uses Remote Code Execution which makes the threat of the vulnerability much higher.","keywords":[],"articleBody":"CVE-2021-1675 is a elevation of privilege vulnerability that affected all Windows Servers from version 2004 to 20H2 and all windows desktops from Windows 7 to Windows 10. While CVE-2021-1675 and CVE-2021-34527 (PrintNightmare) take advantage of the windows print spooler, both exploits approach the vulnerability in different ways. CVE-2021-1675 can only be exploited locally and is only used to escalate user privileges while PrintNightmare is uses Remote Code Execution which makes the threat of the vulnerability much higher.\nBreakdown of CVE-2021-1675 The initially discovered exploit is a Local Privilege Escalation to create a user with admin permissions. The source of the vulnerability is the AddPrinterDriverEx function on windows systems, which installs a printer driver and links the configuration, data and driver files. Microsoft states that the function of AddPrinterDriverEx requires SeLoadDriverPivilege which is only given to Administrators and Print Operators. however, using the parameters in the function, the SeLoadDriverPrivilege check can be bypassed.\nThe AddPrinterDriverEx function requires 4 parameters:\nBOOL AddPrinterDriverEx( _In_ LPTSTR pName, _In_ DWORD Level, _Inout_ LPBYTE pDriverInfo, _In_DWORD dwFileCopyFlags );  pName is the name of the server on which the driver should be installed Level is the DriverInfo structure version pDriverInfo is the structure with all the printer driver information dwFileCopyFlags is the option for copying driver files  To exploit the function the following Proof of Concept is used,\n$APD_COPY_ALL_FILES = 0x00000004 $driver_info = New-Object $DRIVER_INFO_2 $driver_info.cVersion = 3 $driver_info.pConfigFile = $DLL $driver_info.pDataFile = $DLL $pDriverInfo = [System.Runtime.InteropServices.Marshal]::AllocHGlobal([System.Runtime.InteropServices.Marshal]::SizeOf($driver_info)) [System.Runtime.InteropServices.Marshal]::StructureToPtr($driver_info, $pDriverInfo, $false) AddPrinterDriverEx($null, 2, $pDriverInfo, $APD_COPY_ALL_FILES -bor 0x10 -bor 0x8000 The pName parameter chosen was Null, as if the value is null, the function installs the driver on the local computer. Driver Level structure version 2 was chosen with the $pDriverInfo containing the payload as a Dynamic Linked Library (DLL) in its config file and data file. The $APD_COPY_ALL_FILES being set to 0x00000004 and having “-bor 0x10 -bor 0x8000” is requirement to bypass the authentication check done by the function\nBypassing Authentication Within the spoolsv.exe process there is a DLL called localspl.dll which contains a Function called SplAddPrinterDriverEx. The code contains the requirements for the AddPrinterDriverEx function to be executed. In the code Var_5 is set to 0 with a following “if statement” seeing if the 15th bit in param_4 is a 0. If the result is a 0, Var5 is set to param_7\nThe next if statement says if Var5 does not equal 0, then it will attempt to verify the user’s permission to execute the function. However the important part of the code is that the param_4 is editable by the attacker. As the base bit of the APD_COPY_ALL_FILES is set to 4, and a bitwise OR operation is run on 10 and 8000, the total hex value is 8014 which is 1000 0000 0001 0100 in binary. Due to the bit check including 0, the 15th bit in param_4 is now a 1, skipping all authentication. This means that an attacker can add a printer drive which has the privileges of the system.\nTo upload the payload to create a new administrator, a DLL payload is created, encoded then placed into the $pDriverInfo so when the driver is run, the code can be executed as system.\nTo see the CVE exploited, view my HackTheBox Writeup on Driver\n","wordCount":"541","inLanguage":"en","datePublished":"2022-03-23T05:04:42-07:00","dateModified":"2022-03-23T05:04:42-07:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://kkso.github.io/cvebreakdowns/cve-2021/"},"publisher":{"@type":"Organization","name":"kkso's Writeups","logo":{"@type":"ImageObject","url":"https://kkso.github.io/favicon.ico"}}}</script></head><body class=dark id=top><header class=header><nav class=nav><div class=logo><a href=https://kkso.github.io/ accesskey=h title="kkso's Writeups (Alt + H)">kkso's Writeups</a>
<span class=logo-switches></span></div><ul id=menu><li><a href=https://kkso.github.io/cvebreakdowns/ title="CVE Breakdowns"><span>CVE Breakdowns</span></a></li><li><a href=https://kkso.github.io/writeups/ title="HackTheBox Writeups"><span>HackTheBox Writeups</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>CVE-2021-1675 | The Precursor to PrintNightmare</h1><div class=post-meta><span title="2022-03-23 05:04:42 -0700 -0700">March 23, 2022</span>&nbsp;·&nbsp;3 min</div></header><div class=post-content><p>CVE-2021-1675 is a elevation of privilege vulnerability that affected all Windows Servers from version 2004 to 20H2 and all windows desktops from Windows 7 to Windows 10. While CVE-2021-1675 and CVE-2021-34527 (PrintNightmare) take advantage of the windows print spooler, both exploits approach the vulnerability in different ways. CVE-2021-1675 can only be exploited locally and is only used to escalate user privileges while PrintNightmare is uses Remote Code Execution which makes the threat of the vulnerability much higher.</p><h2 id=breakdown-of-cve-2021-1675>Breakdown of CVE-2021-1675<a hidden class=anchor aria-hidden=true href=#breakdown-of-cve-2021-1675>#</a></h2><p>The initially discovered exploit is a Local Privilege Escalation to create a user with admin permissions. The source of the vulnerability is the AddPrinterDriverEx function on windows systems, which installs a printer driver and links the configuration, data and driver files. Microsoft states that the function of AddPrinterDriverEx requires SeLoadDriverPivilege which is only given to Administrators and Print Operators. however, using the parameters in the function, the SeLoadDriverPrivilege check can be bypassed.</p><p>The AddPrinterDriverEx function requires 4 parameters:</p><pre tabindex=0><code>BOOL AddPrinterDriverEx(
	_In_ LPTSTR pName,
	_In_ DWORD Level,
	_Inout_ LPBYTE pDriverInfo,
	_In_DWORD dwFileCopyFlags );
</code></pre><ul><li>pName is the name of the server on which the driver should be installed</li><li>Level is the DriverInfo structure version</li><li>pDriverInfo is the structure with all the printer driver information</li><li>dwFileCopyFlags is the option for copying driver files</li></ul><p>To exploit the function the following Proof of Concept is used,</p><pre tabindex=0><code>$APD_COPY_ALL_FILES = 0x00000004

$driver_info = New-Object $DRIVER_INFO_2
$driver_info.cVersion = 3
$driver_info.pConfigFile = $DLL
$driver_info.pDataFile = $DLL

$pDriverInfo = [System.Runtime.InteropServices.Marshal]::AllocHGlobal([System.Runtime.InteropServices.Marshal]::SizeOf($driver_info))
[System.Runtime.InteropServices.Marshal]::StructureToPtr($driver_info, $pDriverInfo, $false)

AddPrinterDriverEx($null, 2, $pDriverInfo, $APD_COPY_ALL_FILES -bor 0x10 -bor 0x8000
</code></pre><p>The pName parameter chosen was Null, as if the value is null, the function installs the driver on the local computer. Driver Level structure version 2 was chosen with the $pDriverInfo containing the payload as a Dynamic Linked Library (DLL) in its config file and data file. The $APD_COPY_ALL_FILES being set to 0x00000004 and having &ldquo;-bor 0x10 -bor 0x8000&rdquo; is requirement to bypass the authentication check done by the function</p><h2 id=bypassing-authentication>Bypassing Authentication<a hidden class=anchor aria-hidden=true href=#bypassing-authentication>#</a></h2><p>Within the spoolsv.exe process there is a DLL called localspl.dll which contains a Function called SplAddPrinterDriverEx.
<img loading=lazy src=/img/CVEs/cve-2021-1675/1.png alt="image | 600">
The code contains the requirements for the AddPrinterDriverEx function to be executed.
In the code Var_5 is set to 0 with a following &ldquo;if statement&rdquo; seeing if the 15th bit in param_4 is a 0.
If the result is a 0, Var5 is set to param_7</p><p>The next if statement says if Var5 does not equal 0, then it will attempt to verify the user&rsquo;s permission to execute the function.
However the important part of the code is that the param_4 is editable by the attacker. As the base bit of the APD_COPY_ALL_FILES is set to 4, and a bitwise OR operation is run on 10 and 8000, the total hex value is 8014 which is 1000 0000 0001 0100 in binary. Due to the bit check including 0, the 15th bit in param_4 is now a 1, skipping all authentication. This means that an attacker can add a printer drive which has the privileges of the system.</p><p>To upload the payload to create a new administrator, a DLL payload is created, encoded then placed into the $pDriverInfo so when the driver is run, the code can be executed as system.</p><p>To see the CVE exploited, view my <a href=/writeups/driver>HackTheBox Writeup on Driver</a></p></div><footer class=post-footer></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://kkso.github.io/>kkso's Writeups</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script></body></html>